<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…é€”åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .todo-card { transition: transform 0.1s ease; cursor: pointer; position: relative; overflow: hidden; }
        .todo-card:active { transform: scale(0.98); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
        
        /* å¯¼å‡ºå›¾ç‰‡é•¿æŒ‰ä¿®å¤ä¸“ç”¨ CSS */
        #preview-img-tag {
            -webkit-touch-callout: default !important;
            user-select: auto !important;
            -webkit-user-select: auto !important;
            pointer-events: auto !important;
            display: block;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
        }

        .header-mask {
            background: linear-gradient(90deg, 
                rgba(37, 99, 235, 0.7) 0%, 
                rgba(37, 99, 235, 0.3) 15%, 
                rgba(37, 99, 235, 0) 30%, 
                rgba(37, 99, 235, 0) 70%, 
                rgba(37, 99, 235, 0.3) 85%, 
                rgba(37, 99, 235, 0.7) 100%);
        }

        #pdf-template { 
            position: fixed; 
            left: -9999px; 
            top: 0; 
            width: 375px; 
            background: white; 
            z-index: 0;
        }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loader { animation: spin 1s linear infinite; }

        .cat-tag-å¿…å¤‡ { background-color: #fee2e2; color: #ef4444; border-left: 4px solid #ef4444; }
        .cat-tag-æ™¯ç‚¹ { background-color: #dcfce7; color: #22c55e; border-left: 4px solid #22c55e; }
        .cat-tag-ç¾é£Ÿ { background-color: #fef9c3; color: #ca8a04; border-left: 4px solid #ca8a04; }
        .cat-tag-ä½å®¿ { background-color: #e0f2fe; color: #0ea5e9; border-left: 4px solid #0ea5e9; }
        .cat-tag-è´­ç‰© { background-color: #f3e8ff; color: #a855f7; border-left: 4px solid #a855f7; }

        .btn-å¿…å¤‡.active { background-color: #ef4444; color: white; }
        .btn-æ™¯ç‚¹.active { background-color: #22c55e; color: white; }
        .btn-ç¾é£Ÿ.active { background-color: #ca8a04; color: white; }
        .btn-ä½å®¿.active { background-color: #0ea5e9; color: white; }
        .btn-è´­ç‰©.active { background-color: #a855f7; color: white; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="relative pt-12 pb-6 px-6 rounded-b-[2.5rem] shadow-xl bg-blue-600 overflow-hidden text-white shrink-0">
        <div id="header-bg" class="absolute inset-0 bg-cover bg-center"></div>
        <div class="absolute inset-0 header-mask"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-center mb-4">
                <div onclick="toggleDestModal(true)" class="flex items-center gap-2 cursor-pointer bg-black/10 px-3 py-1 rounded-full backdrop-blur-sm">
                    <h1 class="text-2xl font-bold" id="current-dest-name">æˆ‘çš„æ—…ç¨‹</h1>
                    <i class="fas fa-caret-down opacity-60"></i>
                </div>
                <label class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center cursor-pointer backdrop-blur-md">
                    <i class="fas fa-camera text-sm"></i>
                    <input type="file" accept="image/*" class="hidden" onchange="handleHeaderUpload(this)">
                </label>
            </div>
            <div class="flex justify-between items-center px-2">
                <p class="text-blue-100 text-sm font-medium drop-shadow-md" id="current-date">--æœˆ--æ—¥ æ˜ŸæœŸ--</p>
                <div class="flex gap-4 text-xs font-bold bg-black/20 px-4 py-2 rounded-full backdrop-blur-md">
                    <span id="stat-pending">å¾…åŠ 0</span>
                    <span class="opacity-30">|</span>
                    <span id="stat-completed">å®Œæˆ 0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav id="nav-filters" class="flex gap-2 px-6 py-4 overflow-x-auto no-scrollbar shrink-0">
        <button onclick="filterTasks('all', this)" class="cat-btn px-6 py-2 rounded-full bg-blue-600 text-white text-sm font-bold shadow-lg shrink-0 active">å…¨éƒ¨</button>
        <button onclick="filterTasks('å¿…å¤‡', this)" class="cat-btn px-6 py-2 rounded-full bg-white text-slate-500 text-sm font-bold shadow-sm shrink-0 btn-å¿…å¤‡">å¿…å¤‡</button>
        <button onclick="filterTasks('æ™¯ç‚¹', this)" class="cat-btn px-6 py-2 rounded-full bg-white text-slate-500 text-sm font-bold shadow-sm shrink-0 btn-æ™¯ç‚¹">æ™¯ç‚¹</button>
        <button onclick="filterTasks('ç¾é£Ÿ', this)" class="cat-btn px-6 py-2 rounded-full bg-white text-slate-500 text-sm font-bold shadow-sm shrink-0 btn-ç¾é£Ÿ">ç¾é£Ÿ</button>
        <button onclick="filterTasks('ä½å®¿', this)" class="cat-btn px-6 py-2 rounded-full bg-white text-slate-500 text-sm font-bold shadow-sm shrink-0 btn-ä½å®¿">ä½å®¿</button>
        <button onclick="filterTasks('è´­ç‰©', this)" class="cat-btn px-6 py-2 rounded-full bg-white text-slate-500 text-sm font-bold shadow-sm shrink-0 btn-è´­ç‰©">è´­ç‰©</button>
    </nav>

    <!-- Main Todo List -->
    <main id="todo-list" class="flex-1 overflow-y-auto px-6 pb-32 space-y-3 no-scrollbar"></main>

    <!-- Floating Buttons -->
    <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white/90 to-transparent flex justify-between items-center pointer-events-none">
        <div class="pointer-events-auto">
            <button onclick="exportToImage()" id="export-btn" class="bg-white/90 backdrop-blur border border-slate-200 text-slate-600 w-14 h-14 rounded-2xl text-xl font-bold shadow-lg flex items-center justify-center">
                <i class="fas fa-file-export text-blue-500"></i>
            </button>
        </div>
        <button onclick="toggleTodoModal(true)" class="w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 pointer-events-auto">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Hidden Template for rendering -->
    <div id="pdf-template"></div>

    <!-- Image Preview Overlay (Core Fix Layer) -->
    <div id="image-preview-overlay" class="modal-overlay fixed inset-0 hidden z-[1000] flex flex-col items-center justify-center p-6">
        <div class="w-full flex justify-between mb-4">
            <button onclick="closeImagePreview()" class="w-10 h-10 bg-black/40 text-white rounded-full backdrop-blur-md"><i class="fas fa-times"></i></button>
            <div class="flex gap-2">
                <button onclick="toggleFullscreenPreview()" class="px-4 h-10 bg-slate-100 text-slate-700 rounded-full backdrop-blur-md text-sm font-bold">å…¨å±</button>
                <button onclick="openPreviewImage()" class="px-4 h-10 bg-white text-slate-700 rounded-full backdrop-blur-md text-sm font-bold border border-slate-200">æ‰“å¼€</button>
                <button onclick="copyPreviewImage()" class="px-4 h-10 bg-slate-100 text-slate-700 rounded-full backdrop-blur-md text-sm font-bold">å¤åˆ¶</button>
                <button onclick="downloadPreviewImage()" class="px-4 h-10 bg-blue-600 text-white rounded-full backdrop-blur-md text-sm font-bold">ä¿å­˜</button>
            </div>
        </div>
        <div class="relative bg-white p-1 rounded-xl shadow-2xl" id="image-wrap-container"></div>
        <div id="preview-toast" class="mt-4 px-4 py-2 rounded-full text-sm font-bold text-white bg-black/50 backdrop-blur-md hidden">æç¤º</div>
        <div class="text-white mt-8 text-center bg-black/40 px-6 py-3 rounded-full backdrop-blur-md">
            <p class="font-bold mb-1"><i class="fas fa-fingerprint mr-2"></i>é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</p>
            <p class="text-xs opacity-70">æ”¯æŒä¿å­˜å›¾ç‰‡ã€å‘é€ç»™æœ‹å‹</p>
        </div>
    </div>

    <!-- Modal: Add Todo -->
    <div id="todo-modal" class="modal-overlay fixed inset-0 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl">
            <h2 class="text-xl font-bold mb-6 text-slate-800">æ·»åŠ æ–°äº‹é¡¹</h2>
            <input type="text" id="input-text" placeholder="å‡†å¤‡åšä»€ä¹ˆï¼Ÿ" class="w-full bg-slate-100 rounded-2xl px-5 py-4 mb-4 outline-none">
            <div class="grid grid-cols-3 gap-2 mb-8">
                <button onclick="setCat('å¿…å¤‡', this)" class="cat-sel-btn py-3 rounded-xl bg-blue-50 text-blue-600 font-bold border-2 border-blue-200 text-xs">å¿…å¤‡</button>
                <button onclick="setCat('æ™¯ç‚¹', this)" class="cat-sel-btn py-3 rounded-xl bg-slate-50 text-slate-500 font-bold border-2 border-transparent text-xs">æ™¯ç‚¹</button>
                <button onclick="setCat('ç¾é£Ÿ', this)" class="cat-sel-btn py-3 rounded-xl bg-slate-50 text-slate-500 font-bold border-2 border-transparent text-xs">ç¾é£Ÿ</button>
                <button onclick="setCat('ä½å®¿', this)" class="cat-sel-btn py-3 rounded-xl bg-slate-50 text-slate-500 font-bold border-2 border-transparent text-xs">ä½å®¿</button>
                <button onclick="setCat('è´­ç‰©', this)" class="cat-sel-btn py-3 rounded-xl bg-slate-50 text-slate-500 font-bold border-2 border-transparent text-xs">è´­ç‰©</button>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleTodoModal(false)" class="flex-1 py-4 text-slate-400 font-bold">å–æ¶ˆ</button>
                <button onclick="addTodo()" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Modal: Detail View -->
    <div id="detail-modal" class="modal-overlay fixed inset-0 hidden z-50 flex items-end justify-center">
        <div class="bg-white w-full max-w-2xl rounded-t-[3rem] p-8 shadow-2xl max-h-[94vh] flex flex-col">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 shrink-0"></div>
            <div class="flex justify-between items-center mb-8 shrink-0">
                <h2 class="text-2xl font-bold text-slate-800">è¯¦æƒ…è®¾ç½®</h2>
                <button onclick="closeDetailModal()" class="w-10 h-10 bg-slate-100 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-6">
                <input type="text" id="detail-input-text" class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold text-lg">
                <div class="grid grid-cols-2 gap-4">
                    <input type="datetime-local" id="detail-time" class="w-full bg-slate-50 px-5 py-5 rounded-2xl outline-none text-sm">
                    <select id="detail-cat-select" class="w-full bg-slate-50 px-5 py-5 rounded-2xl outline-none text-sm">
                        <option value="å¿…å¤‡">å¿…å¤‡</option>
                        <option value="æ™¯ç‚¹">æ™¯ç‚¹</option>
                        <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                        <option value="ä½å®¿">ä½å®¿</option>
                        <option value="è´­ç‰©">è´­ç‰©</option>
                    </select>
                </div>
                <textarea id="detail-desc" placeholder="ç‚¹å‡»æ·»åŠ å¤‡æ³¨å†…å®¹..." rows="3" class="w-full bg-slate-50 p-5 rounded-2xl outline-none resize-none"></textarea>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-bold text-slate-800">é™„ä»¶å›¾ç‰‡</label>
                        <label class="text-blue-600 text-sm font-bold cursor-pointer">
                            <i class="fas fa-plus-circle"></i>
                            <input type="file" accept="image/*" class="hidden" multiple onchange="handlePhotoUpload(this)">
                        </label>
                    </div>
                    <div id="detail-photo-grid" class="grid grid-cols-3 gap-3"></div>
                </div>
            </div>
            <div class="pt-4 shrink-0 flex gap-3">
                <button onclick="deleteTodo()" class="flex-1 bg-red-50 text-red-500 py-5 rounded-[1.5rem] font-bold">åˆ é™¤</button>
                <button onclick="saveDetails()" class="flex-[3] bg-blue-600 text-white py-5 rounded-[1.5rem] font-bold shadow-xl">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Modal: Destination Switcher -->
    <div id="dest-modal" class="modal-overlay fixed inset-0 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl flex flex-col max-h-[70vh]">
            <h2 class="text-xl font-bold mb-6 text-slate-800 text-center">ç›®çš„åœ°ç®¡ç†</h2>
            <div id="dest-list" class="flex-1 overflow-y-auto space-y-3 no-scrollbar mb-6"></div>
            <div class="flex gap-2">
                <input type="text" id="input-dest" placeholder="æ·»åŠ æ–°è¡Œç¨‹..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="addDestination()" class="bg-blue-600 text-white px-5 rounded-xl font-bold">æ·»åŠ </button>
            </div>
            <button onclick="toggleDestModal(false)" class="mt-6 text-slate-300 font-bold">å…³é—­</button>
        </div>
    </div>

    <script>
        const DB_NAME = 'TravelHelperDB_v1';
        const DB_VERSION = 1;
        let db;

        const StorageManager = {
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('app_state')) db.createObjectStore('app_state');
                        if (!db.objectStoreNames.contains('images')) db.createObjectStore('images');
                    };
                    request.onsuccess = (e) => { db = e.target.result; resolve(); };
                    request.onerror = reject;
                });
            },
            async saveState(state) {
                const tx = db.transaction('app_state', 'readwrite');
                tx.objectStore('app_state').put(JSON.parse(JSON.stringify(state)), 'current_state');
            },
            async getState() {
                const tx = db.transaction('app_state', 'readonly');
                const req = tx.objectStore('app_state').get('current_state');
                return new Promise(res => req.onsuccess = () => res(req.result));
            },
            async saveImage(id, data) {
                const tx = db.transaction('images', 'readwrite');
                tx.objectStore('images').put(data, id);
            },
            async getImage(id) {
                const tx = db.transaction('images', 'readonly');
                const req = tx.objectStore('images').get(id);
                return new Promise(res => req.onsuccess = () => res(req.result));
            },
            async deleteImage(id) {
                const tx = db.transaction('images', 'readwrite');
                tx.objectStore('images').delete(id);
            }
        };

        const $ = id => document.getElementById(id);
        function escapeHTML(s){ return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
        let state = {
            destinations: [{ id: 'd1', name: 'æˆ‘çš„æ—…è¡Œ', cover: '' }],
            activeId: 'd1',
            todos: []
        };
        let currentFilter = 'all';
        let tempCat = 'å¿…å¤‡';
        let activeTodoId = null;

        async function initApp() {
            await StorageManager.init();
            const saved = await StorageManager.getState();
            if (saved) state = saved;
            updateHeader();
            renderTodoList();
            renderDestList();
        }

        function formatTimeDisplay(timeStr) {
            if (!timeStr) return '';
            const date = new Date(timeStr);
            return `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
        }

        function renderStats() {
            const list = state.todos.filter(t => t.destId === state.activeId);
            $('stat-pending').innerText = `å¾…åŠ ${list.filter(t => !t.completed).length}`;
            $('stat-completed').innerText = `å®Œæˆ ${list.filter(t => t.completed).length}`;
        }

        function renderTodoList() {
            const container = $('todo-list');
            const list = state.todos.filter(t => t.destId === state.activeId);
            const filtered = currentFilter === 'all' ? list : list.filter(t => t.category === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="py-20 text-center text-slate-300 opacity-20"><i class="fas fa-mountain text-6xl mb-4"></i><p>ç‚¹ + å·å¼€å§‹è®°å½•</p></div>`;
                renderStats();
                return;
            }

            container.innerHTML = filtered.map(todo => `
                <div class="todo-card bg-white p-5 rounded-[1.5rem] shadow-sm flex items-center gap-3 border-2 border-transparent cat-tag-${todo.category}" onclick="openDetail('${todo.id}')">
                    <div class="p-2 -m-2" onclick="toggleCheck('${todo.id}', event)">
                        <div class="w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all ${todo.completed ? 'bg-blue-600 border-blue-600' : 'bg-white border-blue-100'}">
                            ${todo.completed ? '<i class="fas fa-check text-xs text-white"></i>' : ''}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-slate-800 truncate ${todo.completed ? 'line-through opacity-40' : ''}">${todo.text}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[9px] font-bold px-1.5 py-0.5 rounded-md uppercase" style="background: rgba(0,0,0,0.05)">${todo.category}</span>
                            ${todo.time ? `<span class="text-[9px] font-medium text-slate-400"><i class="far fa-clock mr-1"></i>${formatTimeDisplay(todo.time)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            renderStats();
        }

        function toggleCheck(id, e) {
            e.stopPropagation();
            const todo = state.todos.find(t => t.id === id);
            if (todo) { todo.completed = !todo.completed; renderTodoList(); StorageManager.saveState(state); }
        }

        async function openDetail(id) {
            const todo = state.todos.find(t => t.id === id);
            activeTodoId = id;
            $('detail-input-text').value = todo.text;
            $('detail-time').value = todo.time || '';
            $('detail-cat-select').value = todo.category;
            $('detail-desc').value = todo.desc || '';
            renderPhotoGrid(todo.photoIds || []);
            $('detail-modal').classList.remove('hidden');
        }

        async function saveDetails() {
            const todo = state.todos.find(t => t.id === activeTodoId);
            if (todo) {
                todo.text = $('detail-input-text').value;
                todo.time = $('detail-time').value;
                todo.category = $('detail-cat-select').value;
                todo.desc = $('detail-desc').value;
                await StorageManager.saveState(state);
            }
            closeDetailModal();
            renderTodoList();
        }

        function addTodo() {
            const val = $('input-text').value.trim();
            if (!val) return;
            state.todos.unshift({ id: 't' + Date.now(), destId: state.activeId, text: val, category: tempCat, completed: false, photoIds: [], createdAt: Date.now() });
            $('input-text').value = '';
            toggleTodoModal(false);
            renderTodoList();
            StorageManager.saveState(state);
        }

        async function deleteTodo() {
            state.todos = state.todos.filter(t => t.id !== activeTodoId);
            await StorageManager.saveState(state);
            closeDetailModal();
            renderTodoList();
        }

        function renderDestList() {
            const container = $('dest-list');
            container.innerHTML = state.destinations.map(d => `
                <div class="flex items-center gap-2">
                    <div onclick="switchDest('${d.id}')" class="flex-1 flex items-center justify-between p-4 rounded-2xl border-2 transition-all ${state.activeId === d.id ? 'border-blue-600 bg-blue-50' : 'border-slate-100'}">
                        <span class="font-bold ${state.activeId === d.id ? 'text-blue-600' : 'text-slate-600'}">${d.name}</span>
                    </div>
                    ${state.destinations.length > 1 ? `<button onclick="deleteDest('${d.id}', event)" class="w-12 h-12 bg-red-50 text-red-500 rounded-2xl shrink-0"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>
            `).join('');
        }

        function switchDest(id) { state.activeId = id; updateHeader(); renderTodoList(); toggleDestModal(false); StorageManager.saveState(state); }
        
        async function deleteDest(id, e) {
            e.stopPropagation();
            if (state.destinations.length <= 1) return;
            // æç¤ºç¡®è®¤
            state.destinations = state.destinations.filter(d => d.id !== id);
            state.todos = state.todos.filter(t => t.destId !== id);
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ï¼Œåˆ™åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
            if (state.activeId === id) {
                state.activeId = state.destinations[0].id;
            }
            await StorageManager.saveState(state);
            updateHeader();
            renderTodoList();
            renderDestList();
        }

        function addDestination() {
            const val = $('input-dest').value.trim();
            if (!val) return;
            state.destinations.push({ id: 'd' + Date.now(), name: val, cover: '' });
            $('input-dest').value = '';
            renderDestList();
            StorageManager.saveState(state);
        }

        async function handlePhotoUpload(input) {
            const todo = state.todos.find(t => t.id === activeTodoId);
            for (const file of input.files) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const pid = 'p' + Date.now() + Math.random();
                    await StorageManager.saveImage(pid, e.target.result);
                    todo.photoIds.push(pid);
                    await StorageManager.saveState(state);
                    renderPhotoGrid(todo.photoIds);
                };
                reader.readAsDataURL(file);
            }
        }

        async function renderPhotoGrid(ids) {
            const grid = $('detail-photo-grid');
            grid.innerHTML = '';
            for (const id of ids) {
                const data = await StorageManager.getImage(id);
                grid.innerHTML += `<div class="aspect-square rounded-xl overflow-hidden"><img src="${data}" class="w-full h-full object-cover"></div>`;
            }
        }

        async function handleHeaderUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dest = state.destinations.find(d => d.id === state.activeId);
                const coverId = 'c' + state.activeId;
                await StorageManager.saveImage(coverId, e.target.result);
                dest.cover = coverId;
                await StorageManager.saveState(state);
                updateHeader();
            };
            reader.readAsDataURL(file);
        }

        async function exportToImage() {
            const btn = $('export-btn');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch loader text-blue-500"></i>';
            
            const dest = state.destinations.find(d => d.id === state.activeId);
            const list = state.todos.filter(t => t.destId === state.activeId);
            const temp = $('pdf-template');
            let items = '';
            for (const t of list) {
                let photos = '';
                if (t.photoIds && t.photoIds.length) {
                    for (const id of t.photoIds) {
                        const data = await StorageManager.getImage(id);
                        if (data) {
                            photos += `<div style="width:64px;height:64px;border-radius:8px;overflow:hidden;border:1px solid #e2e8f0;"><img src="${data}" style="width:100%;height:100%;object-fit:cover;"></div>`;
                        }
                    }
                }
                const content = t.desc ? `<div style="font-size:12px;color:#64748b;margin-top:4px;white-space:pre-wrap;">${escapeHTML(t.desc)}</div>` : ``;
                items += `
                    <div style="position:relative; padding-left:20px; border-left:2px solid #e2e8f0; margin-bottom:20px;">
                        <div style="position:absolute; left:-6px; top:6px; width:10px; height:10px; border-radius:50%; background:${t.category==='å¿…å¤‡'?'#ef4444':t.category==='æ™¯ç‚¹'?'#22c55e':'#2563eb'}; border:2px solid #fff;"></div>
                        <div style="font-weight:bold; color:#334155; font-size:16px;">${t.text}</div>
                        <div style="font-size:10px; color:#94a3b8; margin-top:3px;">${t.category} ${t.time? 'Â· '+formatTimeDisplay(t.time) : ''}</div>
                        ${content}
                        ${photos ? `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">${photos}</div>` : ``}
                    </div>
                `;
            }
            const root = document.createElement('div');
            root.setAttribute('id', 'export-root');
            root.setAttribute('style', 'padding:30px;background:#fff;width:375px;font-family:sans-serif;');
            root.innerHTML = `
                <div style="border-bottom: 4px solid #2563eb; padding-bottom: 15px; margin-bottom: 25px;">
                    <h1 style="font-size:26px; margin:0; color:#1e293b;">${dest.name}</h1>
                    <p style="color:#94a3b8; font-size:12px; margin-top:5px;">è¡Œç¨‹æ¸…å• Â· ç”Ÿæˆäº ${new Date().toLocaleDateString()}</p>
                </div>
                ${items}
            `;
            temp.innerHTML = '';
            temp.appendChild(root);

            try {
                const imgs = Array.from(root.querySelectorAll('img'));
                await Promise.all(imgs.map(img => new Promise(res => { if (img.complete) res(); else img.onload = () => res(); })));
                const canvas = await html2canvas(root, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: "#ffffff" });
                const dataUrl = canvas.toDataURL('image/png');
                temp.innerHTML = '';
                if (!dataUrl || dataUrl.length < 50) { btn.innerHTML = original; return; }
                showImagePreview(dataUrl);
                btn.innerHTML = original;
            } catch (err) {
                btn.innerHTML = original;
            }
        }

        function showImagePreview(src) {
            const container = $('image-wrap-container');
            container.innerHTML = `<img id="preview-img-tag" src="${src}" alt="é¢„è§ˆå›¾">`;
            $('image-preview-overlay').classList.remove('hidden');
            const imgEl = $('preview-img-tag');
            let timer = null;
            imgEl.addEventListener('touchstart', () => {
                timer = setTimeout(() => { downloadPreviewImage(); }, 600);
            });
            ['touchend','touchcancel'].forEach(ev => imgEl.addEventListener(ev, () => { if (timer) { clearTimeout(timer); timer = null; } }));
            imgEl.addEventListener('click', () => { downloadPreviewImage(); });
        }

        function closeImagePreview() {
            const img = $('preview-img-tag');
            if(img && img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
            $('image-preview-overlay').classList.add('hidden');
        }
        function showToast(message) {
            const toast = $('preview-toast');
            if(!toast) return;
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }
        function copyPreviewImage() {
            const img = $('preview-img-tag');
            if(!img) return;
            const src = img.src;
            if (navigator.clipboard && window.ClipboardItem) {
                fetch(src).then(r => r.blob()).then(blob => {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).catch(()=>{});
                    showToast('å·²å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿');
                }).catch(()=>{ showToast('å¤åˆ¶å¤±è´¥'); });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(src).then(()=>{ showToast('å·²å¤åˆ¶å›¾ç‰‡é“¾æ¥'); }).catch(()=>{ showToast('å¤åˆ¶å¤±è´¥'); });
            } else {
                showToast('å½“å‰ç¯å¢ƒä¸æ”¯æŒå¤åˆ¶');
            }
        }
        function tryAndroidSave(src) {
            const base64 = src.startsWith('data:') ? src.split(',')[1] : null;
            const filename = `è¡Œç¨‹æ¸…å•_${Date.now()}.png`;
            const android = window.Android || window.app || window.WebApp || window.Native;
            if (!android) return false;
            if (base64 && typeof android.saveBase64Image === 'function') { android.saveBase64Image(base64, filename); showToast('å·²è°ƒç”¨å®‰å“ä¿å­˜æ¥å£'); return true; }
            if (base64 && typeof android.saveImageBase64 === 'function') { android.saveImageBase64(base64, filename); showToast('å·²è°ƒç”¨å®‰å“ä¿å­˜æ¥å£'); return true; }
            if (base64 && typeof android.downloadBase64 === 'function') { android.downloadBase64('image/png', base64, filename); showToast('å·²è°ƒç”¨å®‰å“ä¸‹è½½æ¥å£'); return true; }
            if (typeof android.saveImage === 'function') { android.saveImage(src, filename); showToast('å·²è°ƒç”¨å®‰å“ä¿å­˜æ¥å£'); return true; }
            return false;
        }
        function requestAndroidPermissions() {
            const android = window.Android || window.app || window.WebApp || window.Native;
            let called = false;
            const call = (n) => { if (android && typeof android[n] === 'function') { android[n](); called = true; } };
            call('requestStoragePermission');
            call('requestWritePermission');
            call('requestMediaPermission');
            call('requestPermissions');
            call('requestAllStoragePermissions');
            if (called) showToast('å·²è¯·æ±‚å­˜å‚¨æƒé™');
            return called;
        }
        function openPreviewImage() {
            const img = $('preview-img-tag');
            if(!img) return;
            location.href = img.src;
            showToast('å·²æ‰“å¼€å›¾ç‰‡é¡µé¢');
        }
        async function saveViaFilePicker(src) {
            try {
                if (!window.showSaveFilePicker) return false;
                const handle = await window.showSaveFilePicker({
                    suggestedName: `è¡Œç¨‹æ¸…å•_${new Date().toLocaleDateString('zh-CN')}.png`,
                    types: [{ description: 'PNG å›¾ç‰‡', accept: { 'image/png': ['.png'] } }]
                });
                const writable = await handle.createWritable();
                const blob = await (await fetch(src)).blob();
                await writable.write(blob);
                await writable.close();
                showToast('å·²ä¿å­˜åˆ°æœ¬åœ°');
                return true;
            } catch { return false; }
        }
        function toggleFullscreenPreview() {
            const overlay = $('image-preview-overlay');
            if (!document.fullscreenElement) {
                if (overlay.requestFullscreen) overlay.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
        async function downloadPreviewImage() {
            const img = $('preview-img-tag');
            if(!img) return;
            try {
                if (tryAndroidSave(img.src)) return;
                const picked = await saveViaFilePicker(img.src);
                if (picked) return;
                requestAndroidPermissions();
                const a = document.createElement('a');
                a.href = img.src;
                a.download = `è¡Œç¨‹æ¸…å•_${new Date().toLocaleDateString('zh-CN')}.png`;
                document.body.appendChild(a);
                document.body.removeChild(a);
                setTimeout(() => { try { location.href = img.src; } catch {} }, 200);
                fetch(img.src)
                    .then(r => r.blob())
                    .then(blob => {
                        const file = new File([blob], `è¡Œç¨‹æ¸…å•_${Date.now()}.png`, { type: 'image/png' });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            navigator.share({ files: [file], title: 'è¡Œç¨‹æ¸…å•' }).then(()=>{ showToast('å·²æ‰“å¼€åˆ†äº«'); }).catch(()=>{ showToast('åˆ†äº«å¤±è´¥'); });
                        } else if (navigator.clipboard && window.ClipboardItem) {
                            navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(()=>{ showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }).catch(()=>{ showToast('å¤åˆ¶å¤±è´¥'); });
                        } else {
                            location.href = img.src;
                            showToast('å·²æ‰“å¼€å›¾ç‰‡é¡µé¢');
                        }
                    }).catch(() => {
                        location.href = img.src;
                        showToast('å·²æ‰“å¼€å›¾ç‰‡é¡µé¢');
                    });
            } catch(e) {
                location.href = img.src;
                showToast('å·²æ‰“å¼€å›¾ç‰‡é¡µé¢');
            }
        }

        function toggleTodoModal(s) { $('todo-modal').classList.toggle('hidden', !s); }
        function toggleDestModal(s) { if(s) renderDestList(); $('dest-modal').classList.toggle('hidden', !s); }
        function closeDetailModal() { $('detail-modal').classList.add('hidden'); }
        function setCat(c, el) {
            tempCat = c;
            document.querySelectorAll('.cat-sel-btn').forEach(b => b.className = "cat-sel-btn py-3 rounded-xl bg-slate-50 text-slate-500 font-bold border-2 border-transparent text-xs");
            el.className = "cat-sel-btn py-3 rounded-xl bg-blue-50 text-blue-600 font-bold border-2 border-blue-200 text-xs";
        }
        function filterTasks(c, el) {
            currentFilter = c;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'active');
                b.classList.add('bg-white', 'text-slate-500', 'shadow-sm');
            });
            el.classList.remove('bg-white', 'text-slate-500', 'shadow-sm');
            el.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-lg');
            renderTodoList();
        }
        async function updateHeader() {
            const d = state.destinations.find(x => x.id === state.activeId);
            if(!d) return;
            $('current-dest-name').innerText = d.name;
            $('current-date').innerText = new Date().toLocaleDateString('zh-CN', {month:'short', day:'numeric', weekday:'short'});
            if (d.cover) {
                const data = await StorageManager.getImage(d.cover);
                $('header-bg').style.backgroundImage = `url(${data})`;
            } else {
                $('header-bg').style.backgroundImage = '';
            }
        }
        function applyIconFallback() {
            const map = {
                'plus': '+',
                'camera': 'ğŸ“·',
                'caret-down': 'â–¾',
                'file-export': 'â¤´ï¸',
                'times': 'Ã—',
                'mountain': 'â›°ï¸',
                'trash-alt': 'ğŸ—‘ï¸',
                'check': 'âœ“',
                'fingerprint': 'ğŸ”',
                'plus-circle': 'âŠ•',
                'clock': 'ğŸ•’',
                'circle-notch': 'â†»'
            };
            document.querySelectorAll('i.fas').forEach(el => {
                const cls = Array.from(el.classList).find(c => c.startsWith('fa-'));
                if(!cls) return;
                const name = cls.slice(3);
                const fb = map[name];
                if(fb) el.textContent = fb;
            });
        }

        window.onload = async () => { await initApp(); applyIconFallback(); };
    </script>
</body>
</html>
